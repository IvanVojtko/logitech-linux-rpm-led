name: Build DEB/RPM on Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    env:
      APP_NAME: logitech-rpm-indicator

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from release tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "TAG=$TAG" >> "$GITHUB_ENV"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Using VERSION=$VERSION (from tag $TAG)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install packaging tools (fpm + rpm)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm zip
          sudo gem install --no-document fpm

      # NOTE:
      # PyGObject + pycairo are strongly tied to system libraries.
      # For reliable DEB/RPM installs across distros, we install them as OS deps,
      # and only bundle wheels for the remaining pip packages.
      - name: Install system deps for building wheels (hid)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            python3-dev \
            build-essential \
            libhidapi-dev \
            libusb-1.0-0-dev

      - name: Build dependency wheels (exclude PyGObject/pycairo - use OS packages)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip wheel

          mkdir -p build/wheels

          # Filter out packages we want to provide via distro packages
          # (Avoids "gobject-introspection-1.0 not found" build errors.)
          mkdir -p build
          (grep -vE '^(PyGObject|pycairo)=' requirements.txt > build/requirements-pip.txt) || true

          if [ -s build/requirements-pip.txt ]; then
            pip wheel -r build/requirements-pip.txt -w build/wheels
          else
            echo "No pip-wheel packages after filtering; skipping wheel build."
          fi

      - name: Prepare package root + scripts
        shell: bash
        run: |
          set -euo pipefail

          PKGROOT="pkgroot"
          DIST="dist"
          rm -rf "$PKGROOT" "$DIST"
          mkdir -p "$PKGROOT/opt/$APP_NAME" \
                   "$PKGROOT/usr/bin" \
                   "$PKGROOT/usr/share/doc/$APP_NAME" \
                   "$DIST"

          # Copy only what you want packaged (explicit list avoids .venv, .git, etc.)
          cp -a main.py requirements.txt "$PKGROOT/opt/$APP_NAME/"
          [ -f build/requirements-pip.txt ] && cp -a build/requirements-pip.txt "$PKGROOT/opt/$APP_NAME/requirements-pip.txt" || true

          [ -f README.md ] && cp -a README.md "$PKGROOT/usr/share/doc/$APP_NAME/" || true
          [ -f LICENSE ] && cp -a LICENSE "$PKGROOT/usr/share/doc/$APP_NAME/" || true

          [ -d games ] && cp -a games "$PKGROOT/opt/$APP_NAME/" || true
          [ -d icons ] && cp -a icons "$PKGROOT/opt/$APP_NAME/" || true

          # Bundle wheels we built
          mkdir -p "$PKGROOT/opt/$APP_NAME/wheels"
          if [ -d build/wheels ]; then
            cp -a build/wheels/* "$PKGROOT/opt/$APP_NAME/wheels/" 2>/dev/null || true
          fi

          # Runner wrapper (installed on PATH)
          cat > "$PKGROOT/usr/bin/$APP_NAME" <<EOF
          #!/bin/sh
          set -e
          APP_DIR="/opt/$APP_NAME"
          export PYTHONPATH="\$APP_DIR/.deps:\$PYTHONPATH"
          exec /usr/bin/python3 "\$APP_DIR/main.py" "\$@"
          EOF
          chmod 0755 "$PKGROOT/usr/bin/$APP_NAME"

          # Post-install: install pip-only deps into /opt/<app>/.deps (offline if wheels exist)
          cat > after-install.sh <<'EOF'
          #!/bin/sh
          set -e

          APP_DIR="/opt/__APP_NAME__"
          DEPS_DIR="$APP_DIR/.deps"
          mkdir -p "$DEPS_DIR"

          if command -v pip3 >/dev/null 2>&1; then
            PIP="pip3"
          else
            PIP="/usr/bin/python3 -m pip"
          fi

          # Prefer filtered requirements file if present
          REQ_FILE="$APP_DIR/requirements-pip.txt"
          if [ ! -s "$REQ_FILE" ]; then
            # Fallback (not recommended if it contains PyGObject/pycairo)
            REQ_FILE="$APP_DIR/requirements.txt"
          fi

          if [ -s "$REQ_FILE" ]; then
            # Prefer bundled wheels (offline)
            if [ -d "$APP_DIR/wheels" ] && ls "$APP_DIR/wheels"/*.whl >/dev/null 2>&1; then
              $PIP install --upgrade --no-index --find-links "$APP_DIR/wheels" \
                --target "$DEPS_DIR" -r "$REQ_FILE"
            else
              # Fallback: hits PyPI at install time
              $PIP install --upgrade --target "$DEPS_DIR" -r "$REQ_FILE"
            fi
          fi
          EOF
          sed -i "s/__APP_NAME__/$APP_NAME/g" after-install.sh
          chmod 0755 after-install.sh

      - name: Build .deb and .rpm
        shell: bash
        run: |
          set -euo pipefail
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          DESC="$(head -n 1 README.md 2>/dev/null || echo "$APP_NAME")"
          MAINTAINER="${{ github.actor }}"

          # Debian/Ubuntu runtime deps for PyGObject / Cairo
          # (These replace pip-installed PyGObject/pycairo.)
          DEB_DEPS=(
            --depends "python3"
            --depends "python3-pip"
            --depends "python3-gi"
            --depends "python3-cairo"
            --depends "python3-gi-cairo"
          )

          # Fedora/RHEL/openSUSE runtime deps (names may vary slightly by distro family)
          RPM_DEPS=(
            --depends "python3"
            --depends "python3-pip"
            --depends "python3-gobject"
            --depends "python3-cairo"
          )

          # DEB (arch-independent)
          fpm -s dir -t deb \
            -n "$APP_NAME" \
            -v "$VERSION" \
            -a all \
            --iteration 1 \
            --license "GPL-3.0-only" \
            --maintainer "$MAINTAINER" \
            --url "$REPO_URL" \
            --description "$DESC" \
            --after-install after-install.sh \
            "${DEB_DEPS[@]}" \
            -C pkgroot .

          # RPM (arch-independent)
          fpm -s dir -t rpm \
            -n "$APP_NAME" \
            -v "$VERSION" \
            -a noarch \
            --iteration 1 \
            --license "GPL-3.0-only" \
            --maintainer "$MAINTAINER" \
            --url "$REPO_URL" \
            --description "$DESC" \
            --after-install after-install.sh \
            "${RPM_DEPS[@]}" \
            -C pkgroot .

          mkdir -p dist
          mv ./*.deb dist/
          mv ./*.rpm dist/

      - name: Build source archives (explicit assets)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          git archive --format=tar.gz -o "dist/${APP_NAME}-${VERSION}-src.tar.gz" "$GITHUB_SHA"
          git archive --format=zip    -o "dist/${APP_NAME}-${VERSION}-src.zip" "$GITHUB_SHA"

      - name: Checksums
        shell: bash
        run: |
          set -euo pipefail
          (cd dist && sha256sum * > SHA256SUMS)

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          fail_on_unmatched_files: true
